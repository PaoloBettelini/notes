\documentclass[preview]{standalone}

\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{stellar}
\usepackage{definitions}
\usepackage{listings}
\usepackage{tikz}
\usepackage{fancybox}
\usepackage{makecell}
\usepackage{stackengine}

\definecolor{background}{HTML}{EEEEEE}

\lstdefinelanguage{json}{
    basicstyle=\normalfont\ttfamily,
    numbers=none,
    numberstyle=\scriptsize,
    stepnumber=1,
    numbersep=8pt,
    showstringspaces=false,
    breaklines=true,
    frame=lines,
    stringstyle=\ttfamily\color{red!50!brown},
    morestring=*[d]{"},
    backgroundcolor=\color{background}
}

\begin{document}

\id{compiler-structure}
\genpage

\section{Compiler}

\begin{snippet}{compiler-life-of-program}
    The life of a program looks as follows:

    \begin{center}
    \textbf{
        Source code \(\rightarrow\) compiler \(\rightarrow\) \stackanchor{bytecode}{machine code} \(\rightarrow\) \stackanchor{VM}{CPU}
    }
    \end{center}

    However the compiler is not straightforward

    \renewcommand{\boxed}[1]{\text{\fboxsep=.2em\fbox{\m@th$\displaystyle#1$}}}

    \[
        \textbf{Source code} \rightarrow
        \overbrace{
            \fbox{
                \textbf{Lexer} \(\rightarrow\)
                \textbf{Parser} \(\rightarrow\)
                \textbf{Validator} \(\rightarrow\)
                \textbf{Assembler}    
            }
        }^\text{Compiler} \rightarrow
        \textbf{\stackanchor{Bytecode}{Machine code}} \rightarrow
        \textbf{\stackanchor{VM}{CPU}}
    \]
\end{snippet}

\subsection{Lexer}

\begin{snippetdefinition}{lexical-tokenization-definition}{name}
    \textit{Lexical tokenization} is conversion of a text into
    (semantically or syntactically) meaningful lexical tokens belonging to
    categories defined by a \textit{lexer} program.
\end{snippetdefinition}

\plain{The lexer takes the sources code and produces a list of tokens.}

\begin{snippetexample}{lexer-output-example}{Lexer output}
    \begin{lstlisting}[language=json]
        [
            {
                "type": "identifier",
                "value": "function"
            },
            {
                "type": "identifier",
                "value": "if"
            },
            {
                "type": "identifier",
                "value": "while"
            },
            {
                "type": "literal",
                "value": 42
            },
            {
                "type": "operator",
                "value": "{"
            },
            {
                "type": "operator",
                "value": "}"
            },
            {
                "type": "operator",
                "value": ";"
            }
        ]
    \end{lstlisting}
\end{snippetexample}

\subsection{Parser}

\begin{snippetdefinition}{syntactic-analysis-definition}{Syntactic analysis}
    \textit{Syntactic analysis} is the process of analyzing tokens generated by the
    \snippetref[lexical-tokenization-definition|Lexer][lexer] through a program
    called \textit{parser} and prove an (AST) \textit{Abstract Syntax Tree}.
\end{snippetdefinition}

\begin{snippetexample}{ast-example}{Abstract syntax tree}
    \begin{center}
        \begin{tikzpicture}[
            level 1/.style = {sibling distance = 5cm},
            level 2/.style = {sibling distance = 2.5cm},
            level 3/.style = {sibling distance = 1.75cm},
            level 4/.style = {sibling distance = 0.9cm}
        ]
        \node {\fbox{\makecell{while}}}
            child {
                node {\fbox{\makecell{>}}}
                child {
                    node {\ovalbox{\makecell{a}}}
                }
                child {
                    node {\ovalbox{\makecell{42}}}
                }
            }
            child {
                node {\fbox{\makecell{if}}}
                child {
                    node {\fbox{\makecell{>}}}
                    child {
                        node {\ovalbox{b}}
                    }
                    child {
                        node {\ovalbox{42}}
                    }
                }
                child {
                    node {\ovalbox{\makecell{=}}}
                    child {
                        node {\ovalbox{x}}
                    }
                    child {
                        node {\fbox{+}}
                        child {
                            node {\ovalbox{x}}
                        }
                        child {
                            node {\ovalbox{1}}
                        }
                    }
                }
            };
        \end{tikzpicture}
    \end{center}
\end{snippetexample}

\subsection{Validator}

\begin{snippet}{compiler-validator}
    The validator checks for any error in the AST.
    It checks if every variable exists, function calls are valid and so on.
\end{snippet}

\subsection{Assembler}

\begin{snippet}{compiler-assembler}
    The assembler takes the AST and produces the final compiled code.
\end{snippet}

\end{document}
